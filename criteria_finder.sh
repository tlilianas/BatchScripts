#!/bin/bash
#Define criteria
criteria=criteria*
criteria_2=$(date  --date="yesterday" +"%Y-%m-%d") #Defined as yesterda's date as asked by the customer
today_date=$(date +'%Y-%m-%d')
echo "[~] Creating output files that will contain the results. [~]"
#output file name is a contactination of "Output" + today' date (format : YYYY-mm-dd)
first_row_content="date,meter ip,meter port,serial,credit,gas_total,grid_import_total,r1_grid_import_total,r2_grid_import_total,export_total,r1_export_total,r2_export_total,total_solar_energy_utilised,r1_gen_utilised,r2_gen_utilised,total_import,element_b_total,generation_total,00:00 status,00:00 grid_consumption,00:00 ei_a_export,00:00 charge,00:00 pv_generation,00:00 generation utilised,00:00 grid_energy_used,00:00 export_to_grid,00:30 status,00:30 grid_consumption,00:30 ei_a_export,00:30 charge,00:30 pv_generation,00:30 generation utilised,00:30 grid_energy_used,00:30 export_to_grid,01:00 status,01:00 grid_consumption,01:00 ei_a_export,01:00 charge,01:00 pv_generation,01:00 generation utilised,01:00 grid_energy_used,01:00 export_to_grid,01:30 status,01:30 grid_consumption,01:30 ei_a_export,01:30 charge,01:30 pv_generation,01:30 generation utilised,01:30 grid_energy_used,01:30 export_to_grid,02:00 status,02:00 grid_consumption,02:00 ei_a_export,02:00 charge,02:00 pv_generation,02:00 generation utilised,02:00 grid_energy_used,02:00 export_to_grid,02:30 status,02:30 grid_consumption,02:30 ei_a_export,02:30 charge,02:30 pv_generation,02:30 generation utilised,02:30 grid_energy_used,02:30 export_to_grid,03:00 status,03:00 grid_consumption,03:00 ei_a_export,03:00 charge,03:00 pv_generation,03:00 generation utilised,03:00 grid_energy_used,03:00 export_to_grid,03:30 status,03:30 grid_consumption,03:30 ei_a_export,03:30 charge,03:30 pv_generation,03:30 generation utilised,03:30 grid_energy_used,03:30 export_to_grid,04:00 status,04:00 grid_consumption,04:00 ei_a_export,04:00 charge,04:00 pv_generation,04:00 generation utilised,04:00 grid_energy_used,04:00 export_to_grid,04:30 status,04:30 grid_consumption,04:30 ei_a_export,04:30 charge,04:30 pv_generation,04:30 generation utilised,04:30 grid_energy_used,04:30 export_to_grid,05:00 status,05:00 grid_consumption,05:00 ei_a_export,05:00 charge,05:00 pv_generation,05:00 generation utilised,05:00 grid_energy_used,05:00 export_to_grid,05:30 status,05:30 grid_consumption,05:30 ei_a_export,05:30 charge,05:30 pv_generation,05:30 generation utilised,05:30 grid_energy_used,05:30 export_to_grid,06:00 status,06:00 grid_consumption,06:00 ei_a_export,06:00 charge,06:00 pv_generation,06:00 generation utilised,06:00 grid_energy_used,06:00 export_to_grid,06:30 status,06:30 grid_consumption,06:30 ei_a_export,06:30 charge,06:30 pv_generation,06:30 generation utilised,06:30 grid_energy_used,06:30 export_to_grid,07:00 status,07:00 grid_consumption,07:00 ei_a_export,07:00 charge,07:00 pv_generation,07:00 generation utilised,07:00 grid_energy_used,07:00 export_to_grid,07:30 status,07:30 grid_consumption,07:30 ei_a_export,07:30 charge,07:30 pv_generation,07:30 generation utilised,07:30 grid_energy_used,07:30 export_to_grid,08:00 status,08:00 grid_consumption,08:00 ei_a_export,08:00 charge,08:00 pv_generation,08:00 generation utilised,08:00 grid_energy_used,08:00 export_to_grid,08:30 status,08:30 grid_consumption,08:30 ei_a_export,08:30 charge,08:30 pv_generation,08:30 generation utilised,08:30 grid_energy_used,08:30 export_to_grid,09:00 status,09:00 grid_consumption,09:00 ei_a_export,09:00 charge,09:00 pv_generation,09:00 generation utilised,09:00 grid_energy_used,09:00 export_to_grid,09:30 status,09:30 grid_consumption,09:30 ei_a_export,09:30 charge,09:30 pv_generation,09:30 generation utilised,09:30 grid_energy_used,09:30 export_to_grid,10:00 status,10:00 grid_consumption,10:00 ei_a_export,10:00 charge,10:00 pv_generation,10:00 generation utilised,10:00 grid_energy_used,10:00 export_to_grid,10:30 status,10:30 grid_consumption,10:30 ei_a_export,10:30 charge,10:30 pv_generation,10:30 generation utilised,10:30 grid_energy_used,10:30 export_to_grid,11:00 status,11:00 grid_consumption,11:00 ei_a_export,11:00 charge,11:00 pv_generation,11:00 generation utilised,11:00 grid_energy_used,11:00 export_to_grid,11:30 status,11:30 grid_consumption,11:30 ei_a_export,11:30 charge,11:30 pv_generation,11:30 generation utilised,11:30 grid_energy_used,11:30 export_to_grid,12:00 status,12:00 grid_consumption,12:00 ei_a_export,12:00 charge,12:00 pv_generation,12:00 generation utilised,12:00 grid_energy_used,12:00 export_to_grid,12:30 status,12:30 grid_consumption,12:30 ei_a_export,12:30 charge,12:30 pv_generation,12:30 generation utilised,12:30 grid_energy_used,12:30 export_to_grid,13:00 status,13:00 grid_consumption,13:00 ei_a_export,13:00 charge,13:00 pv_generation,13:00 generation utilised,13:00 grid_energy_used,13:00 export_to_grid,13:30 status,13:30 grid_consumption,13:30 ei_a_export,13:30 charge,13:30 pv_generation,13:30 generation utilised,13:30 grid_energy_used,13:30 export_to_grid,14:00 status,14:00 grid_consumption,14:00 ei_a_export,14:00 charge,14:00 pv_generation,14:00 generation utilised,14:00 grid_energy_used,14:00 export_to_grid,14:30 status,14:30 grid_consumption,14:30 ei_a_export,14:30 charge,14:30 pv_generation,14:30 generation utilised,14:30 grid_energy_used,14:30 export_to_grid,15:00 status,15:00 grid_consumption,15:00 ei_a_export,15:00 charge,15:00 pv_generation,15:00 generation utilised,15:00 grid_energy_used,15:00 export_to_grid,15:30 status,15:30 grid_consumption,15:30 ei_a_export,15:30 charge,15:30 pv_generation,15:30 generation utilised,15:30 grid_energy_used,15:30 export_to_grid,16:00 status,16:00 grid_consumption,16:00 ei_a_export,16:00 charge,16:00 pv_generation,16:00 generation utilised,16:00 grid_energy_used,16:00 export_to_grid,16:30 status,16:30 grid_consumption,16:30 ei_a_export,16:30 charge,16:30 pv_generation,16:30 generation utilised,16:30 grid_energy_used,16:30 export_to_grid,17:00 status,17:00 grid_consumption,17:00 ei_a_export,17:00 charge,17:00 pv_generation,17:00 generation utilised,17:00 grid_energy_used,17:00 export_to_grid,17:30 status,17:30 grid_consumption,17:30 ei_a_export,17:30 charge,17:30 pv_generation,17:30 generation utilised,17:30 grid_energy_used,17:30 export_to_grid,18:00 status,18:00 grid_consumption,18:00 ei_a_export,18:00 charge,18:00 pv_generation,18:00 generation utilised,18:00 grid_energy_used,18:00 export_to_grid,18:30 status,18:30 grid_consumption,18:30 ei_a_export,18:30 charge,18:30 pv_generation,18:30 generation utilised,18:30 grid_energy_used,18:30 export_to_grid,19:00 status,19:00 grid_consumption,19:00 ei_a_export,19:00 charge,19:00 pv_generation,19:00 generation utilised,19:00 grid_energy_used,19:00 export_to_grid,19:30 status,19:30 grid_consumption,19:30 ei_a_export,19:30 charge,19:30 pv_generation,19:30 generation utilised,19:30 grid_energy_used,19:30 export_to_grid,20:00 status,20:00 grid_consumption,20:00 ei_a_export,20:00 charge,20:00 pv_generation,20:00 generation utilised,20:00 grid_energy_used,20:00 export_to_grid,20:30 status,20:30 grid_consumption,20:30 ei_a_export,20:30 charge,20:30 pv_generation,20:30 generation utilised,20:30 grid_energy_used,20:30 export_to_grid,21:00 status,21:00 grid_consumption,21:00 ei_a_export,21:00 charge,21:00 pv_generation,21:00 generation utilised,21:00 grid_energy_used,21:00 export_to_grid,21:30 status,21:30 grid_consumption,21:30 ei_a_export,21:30 charge,21:30 pv_generation,21:30 generation utilised,21:30 grid_energy_used,21:30 export_to_grid,22:00 status,22:00 grid_consumption,22:00 ei_a_export,22:00 charge,22:00 pv_generation,22:00 generation utilised,22:00 grid_energy_used,22:00 export_to_grid,22:30 status,22:30 grid_consumption,22:30 ei_a_export,22:30 charge,22:30 pv_generation,22:30 generation utilised,22:30 grid_energy_used,22:30 export_to_grid,23:00 status,23:00 grid_consumption,23:00 ei_a_export,23:00 charge,23:00 pv_generation,23:00 generation utilised,23:00 grid_energy_used,23:00 export_to_grid,23:30 status,23:30 grid_consumption,23:30 ei_a_export,23:30 charge,23:30 pv_generation,23:30 generation utilised,23:30 grid_energy_used,23:30 export_to_grid,00:00 status,00:00 grid_consumption,00:00 ei_a_export,00:00 charge,00:00 pv_generation,00:00 generation utilised,00:00 grid_energy_used,00:00 export_to_grid" 
echo $first_row_content > Output_$today_date
#Saving path of files matching our criteria (EML194* and yesterday's date)
grep -rl "$criteria"|grep -rl "$criteria_2" --include \*.csv --exclude=criteria_finder.sh --exclude=Output_$today_date | while read -r filepath ; do
  echo "found match at $filepath"
  first_row_content=$(head -n 1 $filepath)
  raw_grep_result=$(grep "$criteria" $filepath |grep "$criteria_2"  --include \*.csv --exclude=criteria_finder.sh --exclude=Output_$today_date)
  echo $raw_grep_result >> Output_$today_date
done

